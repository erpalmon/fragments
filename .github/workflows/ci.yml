name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_ENV: test
  CI: true
  HUSKY: 0

jobs:
  lint:
    name: ESLint / Prettier
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run format

  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
      - name: Dockerfile Lint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./Dockerfile

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint, dockerfile-lint]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm test

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - name: Install hurl
        run: |
          sudo apt-get update
          curl -LO https://github.com/Orange-OpenSource/hurl/releases/download/4.3.0/hurl_4.3.0_amd64.deb
          sudo apt-get install -y ./hurl_4.3.0_amd64.deb
      - name: Start local services
        run: docker compose up -d
      - name: Setup local AWS resources
        run: ./scripts/local-aws-setup.sh
      - name: Run integration tests
        run: npm run test:integration
      - name: Stop services
        if: always()
        run: docker compose down

  docker-hub:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    needs: [lint, dockerfile-lint, unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Docker login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
      - name: Build image
        run: docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/fragments:latest" .
      - name: Push image
        run: docker push "${{ secrets.DOCKERHUB_USERNAME }}/fragments:latest"
